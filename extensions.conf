[globals]
INTERNAL_TIMEOUT=25
EXTERNAL_TIMEOUT=35
ROUTER_PATH=/usr/local/bin/fastagi_router

[internal]
; Хинты для PJSIP/BLF
exten => 501,hint,PJSIP/501
exten => 502,hint,PJSIP/502
exten => 503,hint,PJSIP/503
exten => 504,hint,PJSIP/504
exten => 505,hint,PJSIP/505
exten => 506,hint,PJSIP/506
exten => 507,hint,PJSIP/507
exten => 508,hint,PJSIP/508
exten => 509,hint,PJSIP/509
exten => 510,hint,PJSIP/510

; Прямой внутренний дозвон (5XX)
exten => _5XX,1,Set(TARGET_EXT=${EXTEN})
same => n,Gosub(sub-dial-internal-unified,s,1)

; Исходящие 6-значные (городские)
exten => _XXXXXX,1,AGI(${ROUTER_PATH},${EXTEN},normalized,${CALLERID(num)})
same => n,Gosub(sub-handle-agi,s,1)

; Унифицированные исходящие 10/11-значные (7, 8)
exten => _[78]XXXXXXXXXX,1,AGI(${ROUTER_PATH},${EXTEN},normalized,${CALLERID(num)})
same => n,Gosub(sub-handle-agi,s,1)

; Унифицированные исходящие с префиксом (+7)
exten => _+7XXXXXXXXXX,1,AGI(${ROUTER_PATH},${EXTEN},normalized,${CALLERID(num)})
same => n,Gosub(sub-handle-agi,s,1)

; Отбой невалидных номеров (должен быть последним)
exten => _X.,1,NoOp(WARNING: invalid number: ${EXTEN})
same => n,Hangup()

[external]
; Входящие звонки. Передача на AGI для определения внутреннего EXT.
exten => _X.,1,AGI(${ROUTER_PATH},${EXTEN},inbound,0)
same => n,GotoIf($["${ROUTE_STATUS}" != "SUCCESS"]?hangup)
same => n,Set(CALLERID(num)=+${CALLERID(num)})
same => n,Gosub(sub-handle-agi,s,1)
same => n(hangup),Hangup()

[sub-dial-internal-unified]
; Дозвон на внутренний номер
exten => s,1,Set(DEVICES=${PJSIP_DIAL_CONTACTS(${TARGET_EXT})})
same => n,GotoIf($["${DEVICES}"=""]?no_devices)
same => n,Dial(${DEVICES},${INTERNAL_TIMEOUT},Ttr)
same => n(return),Return()
same => n(no_devices),NoOp(ERROR: No devices found for ${TARGET_EXT})
same => n,Return()

[sub-dial-external]
; Дозвон на внешний номер
exten => s,1,NoOp(Dial external: ${OUT_NUMBER} via ${DIAL_TRUNK})
same => n,GotoIf($["${OUT_NUMBER}" = "" | "${DIAL_TRUNK}" = ""]?return)
same => n,Dial(PJSIP/${OUT_NUMBER},${EXTERNAL_TIMEOUT},Ttr)
same => n(return),Return()

[sub-handle-agi]
; Обработчик результатов AGI
exten => s,1,GotoIf($["${ROUTE_STATUS}" != "SUCCESS"]?hangup)
same => n,GotoIf($["${IS_INTERNAL_DEST}" = "TRUE"]?dial-internal)
same => n,Gosub(sub-dial-external,s,1)
same => n,Goto(hangup)
same => n(dial-internal),Gosub(sub-dial-internal-unified,s,1)
same => n(hangup),Hangup()